<? /* license

BilugCMS (http://www.bilug.it) - Content Management System for dynamic web sites
Copyright (C) 2005-2008  Federico Villa and Alessio Loro Piana

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 2 of the License.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

For reference, contact bilugcms@vilnet.it


license */ ?>
<?php
switch( $lingua_query ) {
	case 'it':
		$ECOMMERCE_CONTROLLACARRELLOLINGUA = 'Il tuo carrello';
		$ECOMMERCE_ARTICOLOLINGUA = 'Articolo:';
		$ECOMMERCE_PREZZOLINGUA = 'Prezzo';
		$ECOMMERCE_TOTARTICOLILINGUA = 'Totale Articoli:';
		$ECOMMERCE_COSTOSPEDIZIONELINGUA = 'Costo Spedizione:';
		$ECOMMERCE_SCEGLIMETODOLINGUA = 'Scegli il metodo di spedizione:';
		$ECOMMERCE_TOTALELINGUA = 'Totale:';
		$ECOMMERCE_VAIAVANTILINGUA = 'Vai avanti';
		$ECOMMERCE_INFOCOMUNICAZIONILINGUA = 'Per informazioni e/o comunicazioni diverse da quelle indicate in questa procedura, contattate senza esitazioni l&#39;assistenza, destinatario Ecommerce (cliccando sull&#39;immagine della MAIL qui a sinistra).';
		$ECOMMERCE_NESSUNARTICOLOINSLINGUA = 'Nessun articolo inserito';
	break;
	case 'en':
		$ECOMMERCE_CONTROLLACARRELLOLINGUA = 'Check cart';
		$ECOMMERCE_ARTICOLOLINGUA = 'Article:';
		$ECOMMERCE_PREZZOLINGUA = 'Price:';
		$ECOMMERCE_TOTARTICOLILINGUA = 'Article amount:';
		$ECOMMERCE_COSTOSPEDIZIONELINGUA = 'Delivery Cost:';
		$ECOMMERCE_SCEGLIMETODOLINGUA = 'Choose shipping method:';
		$ECOMMERCE_TOTALELINGUA = 'Total:';
		$ECOMMERCE_VAIAVANTILINGUA = 'Go ahead';
		$ECOMMERCE_INFOCOMUNICAZIONILINGUA = 'For information and / or communications other than those indicated in this procedure,contact without hesitation assistance, recipient Ecommerce (click on the Mail image on the left).';
		$ECOMMERCE_NESSUNARTICOLOINSLINGUA = 'No articles selected';
	break;
	case 'fr':
		$ECOMMERCE_CONTROLLACARRELLOLINGUA = 'V&eacute;rifiez panier';
		$ECOMMERCE_ARTICOLOLINGUA = 'Article:';
		$ECOMMERCE_PREZZOLINGUA = 'Prix';
		$ECOMMERCE_TOTARTICOLILINGUA = 'Total des articles:';
		$ECOMMERCE_COSTOSPEDIZIONELINGUA = 'CoÃ»t de livraison:';
		$ECOMMERCE_SCEGLIMETODOLINGUA = 'Choisissez le mode de livraison:';
		$ECOMMERCE_TOTALELINGUA = 'Totale:';
		$ECOMMERCE_VAIAVANTILINGUA = 'poursuivre';
		$ECOMMERCE_INFOCOMUNICAZIONILINGUA = 'Pour plus d&#39;informations et / ou de communications autres que celles sp&eacute;cifi&eacute;es dans cette proc&eacute;dure, veuillez communiquer sans l&#39;aide d&#39;h&eacute;sitation, le destinataire Ecommerce (cliquez sur l&#39;image de courrier sur la gauche).';
		$ECOMMERCE_NESSUNARTICOLOINSLINGUA = 'Aucun &eacute;l&eacute;ment ins&eacute;r&eacute;';
	break;
	case 'de':
		$ECOMMERCE_CONTROLLACARRELLOLINGUA = 'Pr&uuml;fen Warenkorb';
		$ECOMMERCE_ARTICOLOLINGUA = 'Beitrag:';
		$ECOMMERCE_PREZZOLINGUA = 'Preis';
		$ECOMMERCE_TOTARTICOLILINGUA = 'Eintr&auml;ge gesamt:';
		$ECOMMERCE_COSTOSPEDIZIONELINGUA = 'Lieferkosten:';
		$ECOMMERCE_SCEGLIMETODOLINGUA = 'W&auml;hlen Sie die Versandart:';
		$ECOMMERCE_TOTALELINGUA = 'Insgesamt:';
		$ECOMMERCE_VAIAVANTILINGUA = 'Vorangehen';
		$ECOMMERCE_INFOCOMUNICAZIONILINGUA = 'F&uuml;r weitere Informationen und / oder Kommunikation andere als die in diesem Verfahren angegeben, wenden Sie sich bitte ohne zu z&ouml;gern Hilfe, Ecommerce Empf&auml;nger (auf dem Bild von E-Mail Klicken Sie auf der linken Seite).';
		$ECOMMERCE_NESSUNARTICOLOINSLINGUA = 'Keine Artikel eingef&uuml;gt';
	break;
	case 'es':
		$ECOMMERCE_CONTROLLACARRELLOLINGUA = 'Ver cesta';
		$ECOMMERCE_ARTICOLOLINGUA = 'Art&iacute;culo:';
		$ECOMMERCE_PREZZOLINGUA = 'Precio';
		$ECOMMERCE_TOTARTICOLILINGUA = 'Total de art&iacute;culos:';
		$ECOMMERCE_COSTOSPEDIZIONELINGUA = 'Costo de Entrega:';
		$ECOMMERCE_SCEGLIMETODOLINGUA = 'Elija el m&eacute;todo de env&iacute;o:';
		$ECOMMERCE_TOTALELINGUA = 'Total:';
		$ECOMMERCE_VAIAVANTILINGUA = 'Seguir adelante';
		$ECOMMERCE_INFOCOMUNICAZIONILINGUA = 'Para m&aacute;s informaci&oacute;n y / o comunicaciones que no sean los especificados en este procedimiento, por favor p&oacute;ngase en contacto con sin la ayuda vacilaci&oacute;n, receptor de comercio electr&oacute;nico (click en la imagen de correo a la izquierda).';
		$ECOMMERCE_NESSUNARTICOLOINSLINGUA = 'No hay elementos insertados';
	break;
	case 'pt':
		$ECOMMERCE_CONTROLLACARRELLOLINGUA = 'Verifique carrinho';
		$ECOMMERCE_ARTICOLOLINGUA = 'Artigo:';
		$ECOMMERCE_PREZZOLINGUA = 'Pre&ccedil;o';
		$ECOMMERCE_TOTARTICOLILINGUA = 'Total de Itens:';
		$ECOMMERCE_COSTOSPEDIZIONELINGUA = 'Custo de entrega:';
		$ECOMMERCE_SCEGLIMETODOLINGUA = 'Escolha o m&eacute;todo de envio:';
		$ECOMMERCE_TOTALELINGUA = 'Total:';
		$ECOMMERCE_VAIAVANTILINGUA = 'Continuar';
		$ECOMMERCE_INFOCOMUNICAZIONILINGUA = 'Para mais informa&ccedil;&otilde;es e / ou outros que n&atilde;o os especificados neste processo de comunica&ccedil;&atilde;o, entre em contato sem assist&ecirc;ncia hesita&ccedil;&atilde;o, destinat&aacute;rio de com&eacute;rcio eletr&ocirc;nico (clique na imagem do Correio &agrave; esquerda).';
		$ECOMMERCE_NESSUNARTICOLOINSLINGUA = 'Nenhum item inserido';
	break;
}
?>

<script type="text/javascript">

/*abilitare il tasto invia*/
function abilita()
{
	var ctr1 = $("#ctr1").html();
	var ctr2 = $("#ctr2").html();
	var mit = $("#mit").html();
	var ctr4 = $("#ctr4").html();		
	var ctr5 = $("#ctr5").html();
	var ctr6 = $("#ctr6").html();

	if(mit=='<img src=\"<?=_URLSITO?>/img/ok.png\" class=\"ico\">' && mit==ctr1 && mit==ctr2 && mit==ctr4 && mit==ctr5 && mit==ctr6) 
	{
		$("input[value=INVIA]").attr("disabled", false);
	}
	else
	{
		$("input[value=INVIA]").attr("disabled", true);
	}
}

/*evidenzio la text selezionata*/
$(function(){	
	$(":text").bind("focus blur", {}, function (event) {
            if (event.type == "focus") {
                $(this).css(event.data);
            } else {
                $(this).css("background-color","");
            }
    	});
	$("textarea").bind("focus blur", {}, function (event) {
            if (event.type == "focus") {
                $(this).css(event.data);
            } else {
                $(this).css("background-color","");
            }
    	});
abilita();
});

/*controllomail*/
function controllomail(){
	var mail = $("input[name=email]").val();
	var espressione = /^[_a-z0-9+-]+(\.[_a-z0-9+-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)+$/;
	if (!espressione.test(mail))
	{
	    	$("input[name=email]").css("color","red");
		$("#mit").html("<img src='<?=_URLSITO?>/img/del.png' class='ico'>");
	}
	else
		{
			$("input[name=email]").css("color","green");
			$("#mit").html("<img src='<?=_URLSITO?>/img/ok.png' class='ico'>");
		}
abilita();
}

function contr(id)
{
	var x = "#" + id;
	if(id=='ctr1')
	{
		var valore = $("input[name=last_name]").val();
		if(valore!="")
		{
			$(x).html("<img src='<?=_URLSITO?>/img/ok.png' class='ico'>");
		}
		else
		{
			$(x).text("Completare").css("color","red");
		}
	}
	if(id=='ctr2')
	{
		var valore = $("input[name=first_name]").val();
		if(valore!="")
		{
			$(x).html("<img src='<?=_URLSITO?>/img/ok.png' class='ico'>");
		}
		else
		{
			$(x).text("Completare").css("color","red");
		}
	}	
	if(id=='ctr4')
	{
		var valore = $("input[name=address1]").val();
		if(valore!="")
		{
			$(x).html("<img src='<?=_URLSITO?>/img/ok.png' class='ico'>");
		}
		else
		{
			$(x).text("Completare").css("color","red");
		}
	}
	if(id=='ctr5')
	{
		var valore = $("input[name=zip]").val();
		if(valore!="")
		{
			$(x).html("<img src='<?=_URLSITO?>/img/ok.png' class='ico'>");
		}
		else
		{
			$(x).text("Completare").css("color","red");
		}
	}
	if(id=='ctr6')
	{
		var valore = $("input[name=city]").val();
		if(valore!="")
		{
			$(x).html("<img src='<?=_URLSITO?>/img/ok.png' class='ico'>");
		}
		else
		{
			$(x).text("Completare").css("color","red");
		}
	}		
abilita();	
}

/*controllo al caricamento*/
$(document).ready(function() {
var mail = $("input[name=email]").val();
	var espressione = /^[_a-z0-9+-]+(\.[_a-z0-9+-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)+$/;
	if (!espressione.test(mail))
	{
		$("#mit").text("Da completare").css("color","red");
	}
	else
		{
			$("input[name=email]").css("color","green");
			$("#mit").html("<img src='<?=_URLSITO?>/img/ok.png' class='ico'>");
		}

	if($("input[name=email]").val()!='')
	{
		$("#og").html("<img src='<?=_URLSITO?>/img/ok.png' class='ico'>")
	}
	if($("textarea").val()!='')
	{
		$("#tes").html("<img src='<?=_URLSITO?>/img/ok.png' class='ico'>")
	}
abilita();
});


</script>
<?php

$idecom = session_id();

$tipospedizione=$_POST["tipospedizione"];
//controllo e allienemanto carrello con disponibilit&agrave;
//estraggo i codici raggruppandoli dei degli articoli del carrello 
$querycod="SELECT id, codice FROM carrello WHERE utente = '$idecom' AND elimina = 0 GROUP BY codice";
$riscod=mysql_query($querycod);

while($cod=mysql_fetch_row($riscod))
{
	
	//conto quanti prodotti ho nel carrello cn lo stesso codice
		$querycodcount="SELECT count(*) FROM carrello WHERE utente = '$idecom' AND codice = '$cod[1]' AND elimina = 0";
		$riscodcount=mysql_query($querycodcount);
		$count = mysql_fetch_row($riscodcount);
		
	//controllo se ho piu articoli di qll disponibili
		$querycontr="SELECT quantita FROM ecommerce WHERE codice = '$cod[1]'";
		$riscontr=mysql_query($querycontr);
		$contr = mysql_fetch_row($riscontr);
		
		if($count[0]>$contr[0])
		{
			//se ho piu articoli nel carrello di quelli disponibili elimino la differenza
			$dif = $count[0] - $contr[0];
			
			$str="UPDATE carrello SET elimina = 1 WHERE codice = '$cod[1]' LIMIT $dif";
			$risultato=mysql_query($str);
			$controllodisp="ok";
			$link = rurl( 0, 'dettaglio-carrello' );
			echo "<script tyoe=\"text/javascript\"> window.location = '$link' </script>";
		}

}

//estraggo merce carrello e la visualizzo
$query="
	SELECT c.id, c.titolo, c.codice, c.prezzo, c.spedizione, e.id, e.foto 
	FROM carrello c 
	INNER JOIN ecommerce e ON e.codice = c.codice 
	WHERE c.utente = '$idecom' AND c.elimina = 0
";
$ris=mysql_query($query);
?>

<h1><span><?=$ECOMMERCE_CONTROLLACARRELLOLINGUA?></span></h1>

<div class="contenitore ecommerce-dettaglio-carrello">	

  <?php if($controllodisp=="ok") echo"<h3>ATTENZIONE: Disponibilita' cambiate !!! Ricontrollare il carrello</h3>"; ?>

  <?php $tot=0; ?>

  <?php if ( mysql_num_rows( $ris ) > 0 ) : ?>
    	<ul class="lista-dettaglio-carrello">
			<?php while($merce=mysql_fetch_row($ris)) : 
				$prezzoart = number_format($merce[3], 2, ',', '.');
				$prezzoagg = number_format($merce[4], 2, ',', '.');
				if ( $merce[6] == "" )
					$src = _URLSITO . "/custom/archivio/images/standard.jpg";
				elseif ( strpos( $merce[6], array( 'http://', 'https://' ) ) === false )
					$src = $merce[6];	
				else {
					$fototrunk = strrpos($merce[6],"/");
					$fototrunk = $fototrunk + 1;
					$merce[6] = substr($merce[6], $fototrunk);
					$merce[6] = substr($merce[6], 0, strlen($merce[6])-1);
					$src = _URLSITO . "/custom/archivio/images/$merce[6]";
				}
				$src = str_replace('/archivio/images/', '/archivio/.thumbs/images/', $src); ?>
				<li>
					<div class="float250"><img src="<?=$src?>" alt="<?=$merce[1]?>" height="" width=""></div>
					<div class="float500">
						<?php $link_articolo = rurl( $merce[5], 'ecommerce-dettaglio' ); ?>
						<p><strong><a href="<?=$link_articolo?>"><?=$merce[1]?></a></strong></p>
						<?php $link_cancella_articolo = rurl( 0, 'ecommerce-cancella-carrello' ) . "$id/$merce[0]/$merce[0]/dettaglio-carrello/"; ?>
						<p><a href="<?=$link_cancella_articolo?>">Cancella</a></p>
					</div>
					<div class="float160">&euro; <?=$prezzoart?></div>
					<div class="azzerafloat"></div>
				</li><?php
				$totart = $totart + $merce[3];
				$totspeagg = $totspeagg + $merce[4];
			endwhile; ?>
		</ul>
  <?php else : ?>
  	<b><?=$ECOMMERCE_NESSUNARTICOLOINSLINGUA?></b>
  <?php endif; ?>

  <p>&nbsp;</p>
  <p>&nbsp;</p>

  <div class="contenitore">
      <div>
        <h3><?=$ECOMMERCE_TOTARTICOLILINGUA?> <small>
        <?php $totart1 = number_format($totart, 2, ',', '.'); ?>
        <?=$totart1?> &euro;</small></h3>
      </div>

      <div>
        <h3><?=$ECOMMERCE_COSTOSPEDIZIONELINGUA?> <small>
        <?php
        $tipospedizione = isset($_POST["tipospedizione"]) ? $_POST["tipospedizione"] : 0;
        $tipospedizione = isset($_GET["tipospedizione"]) ? $_GET["tipospedizione"] : $tipospedizione;
        if( $tipospedizione == 0 ) {
      		$querysped1="SELECT id FROM spedizione WHERE standard = 'checked'";
      		$rissped1=mysql_query($querysped1);
      		$tiposped1=mysql_fetch_row($rissped1);
      		$tipospedizione = $tiposped1[0];
        }
        
        if ( isset($_POST["tipospedizione"]) ) echo "<script> window.location = '"._URLSITO."/ecommerce/dettaglio-carrello/$tipospedizione/'; </script>";
        
        	//estraggo tutte le fasce del tipo di spedizione
        	$queryfasce="SELECT tipo, minore, maggiore, prezzo FROM spedizione WHERE id = '$tipospedizione' LIMIT 1";
        	$risfasce=mysql_query($queryfasce);
        	$fasce=mysql_fetch_row($risfasce);
        	
        	if( ($totart>$fasce[1]) AND ($totart<$fasce[2]) ) $costo = $fasce[3];
        		
        	$totcosto = $costo + $totspeagg;
        	$totcosto1=number_format($totcosto, 2, ',', '.');
        	echo $totcosto1;
        ?> &euro;</small></h3>
      </div>

      <p>&nbsp;</p>

      <div>
      	<h3><?=$ECOMMERCE_SCEGLIMETODOLINGUA?></h3>
      	<form name="spedizione" method="post" action="<?=_URLSITO?>/ecommerce/dettaglio-carrello/">
        	<ul>
        	<?php
        		$tipospedizione = isset($_POST["tipospedizione"]) ? $_POST["tipospedizione"] : 0;
        		$tipospedizione = isset($_GET["tipospedizione"]) ? $_GET["tipospedizione"] : $tipospedizione;
        		$querysped="SELECT tipo, standard, id FROM spedizione GROUP BY tipo";
        		$rissped=mysql_query($querysped);
        		while( $tiposped = mysql_fetch_row($rissped) ) {
        		  echo "<li>";
        			if( $tipospedizione == 0 ) {
        			?>
        				<?=$tiposped[0]?>
        				<input type="radio" name="tipospedizione" value="<?=$tiposped[2]?>" 
            				<?php
            					if ($tiposped[1]=="checked") echo "checked";
            					else echo " onclick=\"this.form.submit()\" ";
            				?>
        				> 
        			<?php
        			}
        			else {
        			?>
        				<?=$tiposped[0]?>
        				<input type="radio" name="tipospedizione" value="<?=$tiposped[2]?>" 
            				<?php
            					if ($tiposped[2]==$tipospedizione) echo "checked";
            					else echo " onclick=\"this.form.submit()\" ";
            				?>
        				> 
        			<?php
        			}
        		  echo "</li>";  			
        		}
        	?>
          </ul>
      	</form>
      </div>	

      <p>&nbsp;</p>

      <div>
        <h3><?=$ECOMMERCE_TOTALELINGUA?> <small>
        <?php
          $_SESSION['totale_articoli'] = $tot = $totart + $totcosto;
          $tot1 = number_format($tot, 2, ',', '.');
          echo $tot1;?> &euro;</small></h3>
      </div>

      <?php $link = rurl( 0, 'ecommerce-compilazione-form' ) . $tipospedizione; ?>
      <div class="go"><a class="btn" href="<?=$link?>"><?=$ECOMMERCE_VAIAVANTILINGUA?></a></div>

      <p>&nbsp;</p>

      <div style="float: left; margin-right:20px"><a href="<?=_URLSITO?>/contatti/"><img width="70" height="70" src="<?=_URLSITO?>/img/mail1.png"></a></div>
      <p><?=$ECOMMERCE_INFOCOMUNICAZIONILINGUA?></p>

  </div>


</div>
